@echo off
REM FarmTally Jenkins Pipeline Workspace Path Validation Script (Windows)
REM This script validates that all required directories and files exist before build execution

echo ğŸ” Validating FarmTally workspace structure...

set "validation_failed=false"

echo ğŸ“ Checking directory structure...

REM Backend structure (repository root)
if exist "package.json" (
    echo âœ… Found: Backend package.json ^(repository root^)
) else (
    echo âŒ Missing: Backend package.json ^(repository root^)
    set "validation_failed=true"
)

if exist "src" (
    echo âœ… Found: Backend source directory
) else (
    echo âŒ Missing: Backend source directory
    set "validation_failed=true"
)

if exist "src\server.ts" (
    echo âœ… Found: Backend main server file
) else (
    echo âŒ Missing: Backend main server file
    set "validation_failed=true"
)

if exist "tsconfig.json" (
    echo âœ… Found: TypeScript configuration
) else (
    echo âŒ Missing: TypeScript configuration
    set "validation_failed=true"
)

if exist "prisma" (
    echo âœ… Found: Prisma database directory
) else (
    echo âŒ Missing: Prisma database directory
    set "validation_failed=true"
)

if exist "prisma\schema.prisma" (
    echo âœ… Found: Prisma schema file
) else (
    echo âŒ Missing: Prisma schema file
    set "validation_failed=true"
)

REM Frontend structure
if exist "farmtally-frontend" (
    echo âœ… Found: Frontend directory
) else (
    echo âŒ Missing: Frontend directory
    set "validation_failed=true"
)

if exist "farmtally-frontend\package.json" (
    echo âœ… Found: Frontend package.json
) else (
    echo âŒ Missing: Frontend package.json
    set "validation_failed=true"
)

if exist "farmtally-frontend\src" (
    echo âœ… Found: Frontend source directory
) else (
    echo âŒ Missing: Frontend source directory
    set "validation_failed=true"
)

if exist "farmtally-frontend\next.config.ts" (
    echo âœ… Found: Next.js configuration
) else (
    echo âŒ Missing: Next.js configuration
    set "validation_failed=true"
)

REM Build output directories (optional)
if exist "dist" (
    echo âœ… Found: Backend build output directory
) else (
    echo âš ï¸  Optional: Backend build output directory not found
)

if exist "farmtally-frontend\.next" (
    echo âœ… Found: Frontend build output directory
) else (
    echo âš ï¸  Optional: Frontend build output directory not found
)

echo ğŸ”§ Validating build scripts...

findstr /C:"\"build\"" package.json >nul
if %errorlevel% equ 0 (
    echo âœ… Backend build script found
) else (
    echo âŒ Backend package.json missing 'build' script
    set "validation_failed=true"
)

findstr /C:"\"start\"" package.json >nul
if %errorlevel% equ 0 (
    echo âœ… Backend start script found
) else (
    echo âŒ Backend package.json missing 'start' script
    set "validation_failed=true"
)

findstr /C:"\"build\"" farmtally-frontend\package.json >nul
if %errorlevel% equ 0 (
    echo âœ… Frontend build script found
) else (
    echo âŒ Frontend package.json missing 'build' script
    set "validation_failed=true"
)

echo ğŸ” Checking for common path issues...

if exist "backend" (
    echo âš ï¸  Found 'backend' directory - this should not exist in current structure
    echo     Backend files should be in repository root
)

if exist "frontend" (
    echo âš ï¸  Found 'frontend' directory - should be 'farmtally-frontend'
)

echo ğŸ“ Generating path configuration...

(
echo # FarmTally Workspace Path Configuration
echo # Generated by validate-workspace-paths.bat
echo.
echo # Backend paths ^(repository root^)
echo BACKEND_ROOT=.
echo BACKEND_SRC=src
echo BACKEND_DIST=dist
echo BACKEND_PACKAGE_JSON=package.json
echo.
echo # Frontend paths
echo FRONTEND_ROOT=farmtally-frontend
echo FRONTEND_SRC=farmtally-frontend/src
echo FRONTEND_DIST=farmtally-frontend/.next
echo FRONTEND_STATIC=farmtally-frontend/out
echo FRONTEND_PACKAGE_JSON=farmtally-frontend/package.json
echo.
echo # Database paths
echo PRISMA_ROOT=prisma
echo PRISMA_SCHEMA=prisma/schema.prisma
echo.
echo # Build artifact paths
echo BACKEND_ARTIFACTS=dist/*
echo FRONTEND_ARTIFACTS=farmtally-frontend/.next/*,farmtally-frontend/out/*
echo.
echo # Validation timestamp
echo VALIDATION_TIMESTAMP=%date% %time%
) > workspace-paths.env

echo âœ… Path configuration saved to workspace-paths.env

echo ================================================

if "%validation_failed%"=="false" (
    echo ğŸ‰ Workspace validation completed successfully!
    echo âœ… All required paths and files are present
    echo âœ… Build scripts are properly configured
    echo âœ… Path configuration generated
    exit /b 0
) else (
    echo âŒ Workspace validation failed!
    echo Please fix the issues above before running the pipeline
    exit /b 1
)